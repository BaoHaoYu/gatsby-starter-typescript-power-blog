---
title: docker(三)：管理nodejs项目
date: 2020-03-06 10:29:00
tags:
  - docker
type: 'categories'
categories:
  - 编程
  - docker
---

通过`nodejs`项目窥视`docker`对项目的管理优势

- [docker(一)：入门](</docker/docker(一)：入门/>)
- [docker(二)：linux 下配置 docker](</docker/docker(三)：管理nodejs项目/>)
- [docker(三)：管理 nodejs 项目](</docker/docker(三)：管理nodejs项目/>)

<!-- more -->

## 项目大概的样子

![](http://bhyblog.oss-cn-shenzhen.aliyuncs.com/hexo/Code_BFyM5gcB2O.png)

`demo1/index.js`

```js
var express = require('express')
var app = express()

app.use(express.static('dist'))

var server = app.listen(1234, function() {
  var host = server.address().address
  var port = server.address().port

  console.log('Example app listening at http://%s:%s', host, port)
})
```

`demo1/package.json`

```json
{
  "name": "docker-nodejs",
  "version": "1.0.0",
  "main": "index.js",
  "license": "ISC",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "express": "^4.16.3"
  }
}
```

## 使用网易云加速镜像下载

在[镜像](https://c.163yun.com/hub)中搜索

有鲸鱼标记的就是官方的
![](http://bhyblog.oss-cn-shenzhen.aliyuncs.com/hexo/chrome_Djy1eM7w2L.png)

点击复制地址
![](http://bhyblog.oss-cn-shenzhen.aliyuncs.com/hexo/chrome_X6FlOQpPoS.png)
拉取镜像

```bash
docker pull hub.c.163.com/library/node:latest
```

![](http://bhyblog.oss-cn-shenzhen.aliyuncs.com/hexo/Xshell_VeEBs42i0g.png)

拉取完毕后查看镜像

```bash
docker images
```

![](http://bhyblog.oss-cn-shenzhen.aliyuncs.com/hexo/Xshell_aSSCS7rcaw.png)

发现`nodejs`镜像高达 669MB，但是由于镜像的共享特性，占据的空间并不会比之前大，请看[《深刻理解 Docker 镜像大小》](https://www.cnblogs.com/claireyuancy/p/7029126.html)

## Dockerfile

配置文件

```dockerfile
# 依赖的镜像
FROM hub.c.163.com/library/node:latest
# 作者
MAINTAINER bhy

# 运行linux命令，生成文件夹
RUN mkdir -p /usr/src/node-project/demo1
# 拷贝文件
COPY ./dist ./usr/src/node-project/demo1/dist/
COPY package.json /usr/src/node-project/demo1
COPY index.js /usr/src/node-project/demo1

# 指定工作空间
WORKDIR /usr/src/node-project/demo1
RUN npm config set registry https://registry.npm.taobao.org
RUN npm install
# 环境变量HOST
ENV HOST 0.0.0.0
ENV PORT 1234
# 暴露的端口
EXPOSE 1234
# CMD命令，注意不可以有空格
CMD ["node","index.js"]
```

## dockerignore

打包项目成镜像要忽略的文件

```dockerignore
# Logs
logs
*.log
npm-debug.log*

# Runtime data
pids
*.pid
*.seed

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage

# nyc test coverage
.nyc_output

# Grunt intermediate storage (http://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# node-waf configuration
.lock-wscript

# Compiled binary addons (http://nodejs.org/api/addons.html)
build/Release

# Dependency directories
node_modules
jspm_packages

# Optional npm cache directory
.npm

# Optional REPL history
.node_repl_history
.idea
.node_modules
node_modules
.vscode
```

## 创建镜像

```bash
docker build -t docker_demo1 .
```

查看创建的镜像
![](http://bhyblog.oss-cn-shenzhen.aliyuncs.com/hexo/Xshell_UNBleCylM2.png)

## 启动容器

启动容器，`-d`表示后台运行，`-p`表示指定端口映射，`1234`是`docker`容器暴露的端口

```bash
docker run -d -p 8000:1234 docker_demo1
```

通过`ip:端口`访问容器内容[http://192.168.253.128:8000/](http://192.168.253.128:8000/)
![](http://bhyblog.oss-cn-shenzhen.aliyuncs.com/hexo/chrome_mlMTPIoJkY.png)

通过命令查看启动的容器

```bash
docker ps
```

## 结语

1. 解决配置和版本冲突
   创建镜像之后，镜像可以转移到其他系统中，不用担心里面的`nodejs`版本和新系统冲突。复杂一点的项目就有`mysql`，`jdk`，`tomcat`，`nginx`等东西，封装成镜像，在容器中隔离运行，就丝毫不用担心和其他项目版本冲突，配置冲突等问题。

2. 镜像共享
   如图，`docker_demo1`显示大小是`672MB`，其实里面的`hub.c.163.com/library/node`是共享的，所以`docker_demo1`实际所占有的空间是`672-669=3MB`。
   ![](http://bhyblog.oss-cn-shenzhen.aliyuncs.com/hexo/Xshell_hIwTClAJAq.png)

3. 镜像独立
   后来我部署了`docker_demo2`项目，`docker_demo1`和`docker_demo2`都同时使用了`hub.c.163.com/library/node`镜像，但是`docker_demo1`使用淘宝源，`docker_demo2`安装镜像的时候，但是并未淘宝源覆盖。所以多个项目对共有的镜像进行配置是不会相互影响，保持独立。
   `docker_demo1`
   ![](http://bhyblog.oss-cn-shenzhen.aliyuncs.com/hexo/Xshell_s0X9kLS93y.png)
   `docker_demo2`
   ![](http://bhyblog.oss-cn-shenzhen.aliyuncs.com/hexo/Xshell_6cNPV1Lm1L.png)

## 常见命令

通过`Dockerfile`创建镜像

```bash
docker build -t docker_demo1 .
```

启动容器，`-d`表示后台运行，`-p`表示指定端口映射

```bash
docker run -d -p 8000:1234 docker_demo1
```

删除镜像

```bash
docker rmi [镜像id]
```

停止容器

```bash
docker stop [容器id]
```

删除容器

```bash
docker rm [容器id]
```

正在运行的容器

```bash
docker ps
```

所有容器

```bash
docker ps -a
```
